#!/bin/sh
# cvecheck-py.sh: do CVE checks
# usage: cvecheck-py.sh [--write-json]

set -e

export THIS_DIR=$(realpath $(dirname $0))
. ${THIS_DIR}/variables.sh

PROJ_DIR=${TOP_DIR}/cryptol-remote-api/python

echo
echo "Running pip-audit in ${PROJ_DIR}:"

if [ $# == 0 ] ; then
    ARGS=""
elif [ $# -eq 1 ] && [ $1 = "--write-json" ] ; then
    ARGS="-f json -o ${PY_JSON_FILE}"
else
  echo "Usage: cvecheck-py.sh [--write-json]"
  exit 1
fi

cd ${PROJ_DIR}

poetry export -frequirements.txt -o tmp-requirements.txt

pip-audit -r ./tmp-requirements.txt ${ARGS}
